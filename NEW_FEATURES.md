# 代码执行器插件新功能说明

## 新增配置项

### 1. 本地路由发送功能

**配置项**: `enable_local_route_sending`
- **类型**: 布尔值 (bool)
- **默认值**: `false`
- **说明**: 启用后将把文件挂载到本地路由进行网络文件发送，适用于AstrBot和发送框架不在同一网络的情况

**工作原理**:
- 当启用本地路由发送时，插件会通过WebUI服务器提供文件URL
- 文件通过 `http://{local_route_host}:{webui_port}/files/{filename}` 路径访问
- 插件将文件URL直接传递给AstrBot的文件发送功能，支持图片和普通文件
- 对于图片文件，使用 `MessageChain().file_image(url)` 发送
- 对于普通文件，使用 `Comp.File(file=url, name=filename)` 发送

**安全特性**:
- 只允许访问配置的输出目录内的文件
- 包含路径遍历攻击防护
- 文件访问权限严格控制

### 2. Lagrange服务器IP配置

**配置项**: `lagrange_host`
- **类型**: 字符串 (string)
- **默认值**: `"127.0.0.1"`
- **说明**: Lagrange服务器的IP地址，默认为127.0.0.1（本地），如果AstrBot和Lagrange不在同一主机请填写Lagrange的IP地址

### 3. 本地路由主机配置

**配置项**: `local_route_host`
- **类型**: 字符串 (string)
- **默认值**: `"localhost"`
- **说明**: 配置本地路由发送时使用的主机IP地址，设置文件服务的主机地址，支持局域网IP以便Docker等环境访问

**使用场景**:
- 当AstrBot和Lagrange部署在不同服务器时
- 需要跨网络访问Lagrange服务时
- 支持远程Lagrange实例

## 文件发送优先级

插件现在支持四种文件发送方式，按以下优先级尝试发送，如果前一种方式失败会自动尝试下一种：

1. **本地路由发送** (`enable_local_route_sending = true`)
   - 优先尝试
   - 通过WebUI提供文件下载链接
   - 适用于跨网络场景

2. **Lagrange适配器** (`enable_lagrange_adapter = true`)
   - 本地路由失败时尝试
   - 通过Lagrange API上传文件
   - 支持远程Lagrange服务器

3. **AstrBot原生方式** (默认)
   - 前两种都失败时使用
   - 使用AstrBot框架自带的文件发送功能
   - 适用于标准部署场景

4. **Base64编码发送** (最后备用方案)
   - 当所有其他发送方式都失败时使用
   - 将文件编码为base64格式发送
   - 文件大小限制：5MB (考虑到base64编码会增加约33%的大小)
   - 支持图片和普通文件的base64发送
   - 适用于网络环境复杂或其他发送方式不可用的情况

**容错机制**: 如果某种发送方式失败，系统会自动尝试下一种可用的发送方式，确保文件能够成功发送。

## WebUI功能优化

### 问题背景
1. 在AstrBot插件热重载过程中，WebUI挂载的端口可能未正确释放，导致端口二次占用而引起崩溃问题
2. 用户反馈卸载插件时可能导致AstrBot崩溃
3. WebUI功能并非所有用户都需要，但默认启用可能造成不必要的资源占用和潜在问题

### 解决方案
1. 实现了智能端口管理和动态端口分配机制，彻底解决热重载时的端口冲突问题
2. **新增WebUI开关功能，默认关闭WebUI服务**，用户可根据需要手动启用
3. 简化了插件卸载逻辑，避免崩溃问题

### 热重载端口冲突解决

插件现在包含了完善的端口管理机制，解决了AstrBot热重载插件时可能出现的端口占用问题：

#### 改进功能
1. **WebUI开关控制**: 
   - 新增 `enable_webui` 配置项，默认为 `false`
   - 只有手动启用时才会初始化和启动WebUI服务
   - 避免不必要的资源占用和潜在端口冲突

2. **智能端口检测**: 启动前自动检测端口是否被占用
3. **动态端口分配**: 当配置端口被占用时，自动寻找可用端口（范围：配置端口+0到+9）
4. **优雅关闭**: 改进的服务器停止机制，确保端口完全释放
5. **强制清理**: 在重载时强制清理残留的服务器引用
6. **详细日志**: 提供清晰的错误信息和解决建议
7. **简化卸载**: 优化插件卸载逻辑，避免崩溃问题

#### 错误处理
- 当配置端口被占用时，自动寻找可用端口并提示用户
- 如果无法找到可用端口，会显示详细的错误信息和解决方案
- 实时显示实际使用的端口，确保用户能正确访问WebUI
- 提供多种解决方案：重启AstrBot、修改端口配置到更高端口号

#### 使用说明

**启用WebUI服务**:
1. 在插件配置中将 `enable_webui` 设置为 `true`
2. 配置 `webui_port`（可选，默认22334）
3. 重启插件或重载配置
4. 访问 `http://localhost:端口号` 查看WebUI界面

**注意事项**:
- WebUI默认关闭，需要手动启用
- 启用WebUI会占用一个端口，请确保端口未被其他程序使用
- 如果遇到端口冲突，系统会自动寻找可用端口
- 不需要WebUI功能时建议保持关闭状态

#### 技术实现
- 配置驱动：通过 `enable_webui` 配置项控制WebUI的初始化和启动
- 条件初始化：只有启用时才创建WebUI实例，避免资源浪费
- 使用socket检测端口状态
- 动态端口分配算法（配置端口+0到+9范围内寻找）
- 改进的uvicorn服务器生命周期管理
- 异步任务的正确取消和清理机制
- 超时控制防止无限等待
- 实时端口同步确保URL正确性
- 简化卸载：减少卸载时的复杂操作，避免崩溃

## 配置示例

### 启用本地路由发送
```json
{
  "enable_local_route_sending": true,
  "local_route_host": "192.168.1.50",
  "webui_port": 22334,
  "output_directory": "/path/to/output"
}
```

### 配置远程Lagrange服务器
```json
{
  "enable_lagrange_adapter": true,
  "lagrange_host": "192.168.1.100",
  "lagrange_api_port": 8083
}
```

### 同时启用两种方式（本地路由优先）
```json
{
  "enable_local_route_sending": true,
  "enable_lagrange_adapter": true,
  "lagrange_host": "192.168.1.100",
  "lagrange_api_port": 8083,
  "webui_port": 22334
}
```

## 日志信息

插件启动时会显示当前的文件发送配置状态：

```
本地路由发送已启用，文件服务地址: http://localhost:22334/files/
Lagrange适配器已启用，服务地址: 192.168.1.100:8083
```

或者：

```
使用AstrBot原生文件发送方式
```

## 注意事项

1. **本地路由发送**需要确保WebUI端口可以被目标用户访问
2. **Lagrange配置**需要确保网络连通性和API可用性
3. **安全性**：本地路由发送只允许访问配置的输出目录内的文件
4. **优先级**：如果同时启用多种发送方式，会按优先级选择使用

## 兼容性

- 新功能完全向后兼容
- 不影响现有配置和功能
- 默认情况下使用原有的AstrBot原生发送方式