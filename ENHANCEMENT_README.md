# 代码执行器插件增强功能说明

## 🚀 新增功能概览

本次增强为代码执行器插件添加了以下重要功能：

### 1. 📊 执行历史记录系统
- **自动记录**: 每次代码执行都会自动记录到SQLite数据库
- **详细信息**: 记录发言人ID、昵称、代码内容、执行结果、错误信息等
- **性能统计**: 记录执行耗时，便于性能分析
- **文件追踪**: 记录生成的文件路径

### 2. 🌐 美观的WebUI界面
- **现代化设计**: 白色主色调，简约大气的界面设计
- **响应式布局**: 支持桌面和移动设备访问
- **实时统计**: 显示总执行次数、成功率、用户数量等统计信息
- **详情查看**: 点击记录可查看完整的执行详情

### 3. 🔍 强大的搜索功能
- **关键词搜索**: 支持在代码、描述、用户名中搜索
- **用户筛选**: 可按特定用户ID筛选记录
- **状态筛选**: 可筛选成功或失败的执行记录
- **组合筛选**: 支持多条件组合筛选

### 4. 📄 分页浏览功能
- **智能分页**: 自动分页显示，避免页面过长
- **页码导航**: 提供页码跳转功能
- **每页数量**: 默认每页显示20条记录

## ⚙️ 配置说明

### 新增配置项

在 `_conf_schema.json` 中新增了以下配置项：

```json
{
  "webui_port": {
    "description": "WebUI服务端口",
    "type": "int",
    "default": 22334,
    "hint": "设置历史记录WebUI的访问端口，建议使用冷门端口避免冲突"
  }
}
```

### 配置示例

```json
{
  "timeout_seconds": 90,
  "max_output_length": 3000,
  "enable_plots": true,
  "output_directory": "D:/ai_outputs",
  "webui_port": 22334
}
```

## 🗄️ 数据库结构

插件使用SQLite数据库存储执行历史，数据库文件位于插件数据目录下的 `execution_history.db`。

### 表结构

```sql
CREATE TABLE execution_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sender_id TEXT NOT NULL,           -- 发言人ID
    sender_name TEXT NOT NULL,         -- 发言人昵称
    code TEXT NOT NULL,                -- 执行的代码
    description TEXT,                  -- 任务描述
    success BOOLEAN NOT NULL,          -- 是否执行成功
    output TEXT,                       -- 执行输出
    error_msg TEXT,                    -- 错误信息
    file_paths TEXT,                   -- 生成的文件路径(JSON格式)
    execution_time REAL,               -- 执行耗时(秒)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 🌐 WebUI使用指南

### 访问地址
- 默认地址: `http://localhost:22334`
- 可通过配置文件自定义端口

### 界面功能

#### 1. 统计面板
- 总执行次数
- 成功执行次数
- 失败执行次数
- 成功率
- 用户数量
- 近7天执行次数

#### 2. 搜索控制面板
- **搜索关键词**: 在代码、描述、用户名中搜索
- **用户ID**: 筛选特定用户的执行记录
- **执行状态**: 筛选成功或失败的记录
- **搜索按钮**: 执行搜索
- **重置按钮**: 清空所有筛选条件

#### 3. 记录列表
- 显示执行记录的基本信息
- 点击记录可查看详细信息
- 支持分页浏览

#### 4. 详情模态框
- 显示完整的执行详情
- 包括代码、输出、错误信息、生成文件等

## 🔧 技术实现

### 核心组件

1. **ExecutionHistoryDB** (`database.py`)
   - 数据库操作类
   - 提供异步数据库操作方法
   - 支持分页查询和统计功能

2. **CodeExecutorWebUI** (`webui.py`)
   - WebUI服务类
   - 基于FastAPI构建
   - 提供RESTful API和HTML界面

3. **CodeExecutorPlugin** (`main.py`)
   - 主插件类
   - 集成数据库记录功能
   - 管理WebUI服务生命周期

### 异步架构
- 所有数据库操作都是异步的，不会阻塞主线程
- WebUI服务在后台运行，不影响插件主要功能
- 使用 `asyncio.create_task` 管理并发任务

### 错误处理
- 完善的异常捕获和日志记录
- 数据库操作失败不会影响代码执行功能
- WebUI服务异常不会导致插件崩溃

## 📦 依赖包

新增的依赖包已添加到 `requirements.txt`：

```
# WebUI相关
fastapi
uvicorn[standard]
jinja2
aiosqlite
```

## 🚀 启动流程

1. 插件加载时自动初始化数据库
2. 启动WebUI服务器（默认端口22334）
3. 开始记录代码执行历史
4. 用户可通过浏览器访问历史记录界面

## 🛡️ 安全考虑

- WebUI服务绑定到 `0.0.0.0`，允许局域网访问
- 建议在生产环境中配置防火墙规则
- 数据库文件存储在插件数据目录，权限受系统保护
- 所有用户输入都经过HTML转义处理

## 🔄 升级说明

### 从旧版本升级
1. 更新插件文件
2. 安装新的依赖包: `pip install fastapi uvicorn[standard] jinja2 aiosqlite`
3. 重启AstroBot
4. 访问WebUI界面验证功能

### 数据迁移
- 新版本会自动创建数据库表
- 旧版本的执行记录不会丢失（如果有的话）
- 首次运行会自动初始化数据库结构

## 🎯 使用建议

1. **定期清理**: 建议定期清理过期的执行记录，避免数据库过大
2. **端口配置**: 如果22334端口被占用，请在配置文件中修改端口号
3. **网络访问**: 如需外网访问，请配置适当的网络安全措施
4. **性能监控**: 可通过WebUI界面监控代码执行的性能和成功率

## 🐛 故障排除

### 常见问题

1. **WebUI无法访问**
   - 检查端口是否被占用
   - 查看插件日志中的错误信息
   - 确认防火墙设置

2. **数据库错误**
   - 检查插件数据目录的写入权限
   - 查看数据库文件是否损坏
   - 重启插件重新初始化数据库

3. **记录缺失**
   - 检查数据库连接是否正常
   - 查看插件日志中的错误信息
   - 确认代码执行权限设置

### 日志查看
插件的详细日志可以在AstroBot的日志系统中查看，包括：
- 数据库操作日志
- WebUI服务状态
- 错误和异常信息

## 📞 技术支持

如果在使用过程中遇到问题，请：
1. 查看插件日志获取详细错误信息
2. 检查配置文件是否正确
3. 确认所有依赖包已正确安装
4. 联系插件作者获取技术支持 QQ：723926109

---

**版本**: 2.0.0--enhanced  
**作者**: Xican  
**更新日期**: 2025年7月22日